# 設計指針

Mjolnirの設計・開発における目標には、以下のようなものがあります。

## 柔軟性

新規な力場や手法を簡単に実装できるようにすることは、Mjolnirの目標の一つです。

このために、無理のない範囲で使いまわせるソースコードは使い回し、それを可能にする
ために構成要素間の依存性をできる限り減らしています。

ですが同時に、特別な場合のための最適化の余地を残したり、過剰な抽象化によって
見通しが悪くなるのを防ぐため、意図的に抽象化せずに実装する方法も残しています。

## 透明性

ユーザーにとって予想外のことを実行しないことも、Mjolnirの目標の一つです。

通常、ソフトウェアを開発する時点で将来どのような機能が要求されるかは予想が困難で
す。開発の時点では成り立っていた仮定が後々破れることもあります。そのような場合、
内部で何が起きているかはわかりやすい方が良いでしょう。

## 高速性

上記のルールの範囲内で可能な限り、高速に動作することが、Mjolnirの目標の最後の一つ
です。

シミュレーションソフトウェアにとっての正義とは、実行時間が短いことです。
Mjolnirでは、実行時に不要な計算をできる限り実行せずに済むように、また特別な場合
だけ適用できる最適化の機会を逃さないようにするため、設計上の工夫をいくつか凝らし
ています。

# 具体的な指針

Mjolnirの設計は以下のような方針で行われています。

## 静的解決を優先する

言い換えると、継承より`template`を使うという方針です。

継承が必要になる状況はありますが、その場合も純粋仮想関数を使い、継承も一回しか
行わないようにします。複雑な継承関係はどの箇所が実際に呼ばれているのかをわかり
にくくします。速度の点でも有利ではありません。なので、Mjolnirでは継承は一段階
のみとし、オーバーライドも純粋仮想関数のみとしています。他の言語をご存知の方は、
インターフェースや、Rustのトレイトオブジェクトをイメージして下さい。

また、もしコンパイル時に決定できるものがあるなら、それはコンパイル時に決定します。
これは実行時にできるだけ不要な計算をしないための措置で、高速化のためです。

## ユーザーに指定させる

言い換えると、デフォルトの値はなるべく使わず、ユーザーの意図も推測しないという方針です。

ユーザーが何もしなくても必要なものを勝手に補ってくれる機能は一見便利に見えますが、
実際には背後にあるモデルの学習を妨げ、またカスタマイズを難しくするなど、実際に使う
ときには足枷になることもあります。また、ユーザーの意図を最初から完璧に推測するのは
実際問題として難しいです。

意図を推測するのにもコストがかかるので、結果として挙動もコードも複雑になります。
よほど自明で選択肢が狭い場合以外は、デフォルトで何かを設定するのは避けましょう。
何も書かなくても動く、というのは確かに格好いいですが、それを達成するためだけに
挙動とコードを複雑にしないようにして下さい。

{% hint style='info' %}
工学の立場では、細部を隠蔽し、学習コストをなくすのはよいことであり、一つの到達点です。
上記のポリシーはその逆を言っているように思えるかも知れません。この違いは、対象と
しているユーザーの違いから来ています。ユーザーが自分で新しい何かをすることが前提
なら、カスタマイズする方法を学ぶコストを減らすことが目標になります。そのためには、
細部を隠すのではなくむしろ全てを明確にしたほうがわかりやすい、という考えから上記の
ポリシーに至っています。
{% endhint %}

## 特殊な最適化は、それ専用のコードにする

効率のよいプログラムのために、特定のCPUでしかサポートされていない命令や、
特定のライブラリなどを使用する場合があるでしょう。そのような特殊な状況でのみ
可能な最適化を行ったコードでは、様々な場所に普段は見ない関数や命令が現れることに
なります。

そのようなコードは、サポートされていない環境でも動くようにするために、`#ifdef`を
使ってコードの途中で書き分けることが多いかも知れません。しかしそうするとコードが
長くなり、片方の実装だけを読みたいときに関係のない部分が増えて読みにくくなって
しまいます。

なので、そのような特殊なコードを書く場合は思い切ってファイルごとコピーし、専用の
ディレクトリを作って下さい。ディレクトリごと分かれていればノイズはなくなります。
また、実装する際も、どこからどこまでが共通して使えるかを考えなくてよい分、逆に
楽になるでしょう。

Mjolnirはそのような切り分けを前提とした設計になっています。例えば、OpenMPを使った
コードは上記の方法で完全に隔離されています。詳しくは、`mjolnir/omp/`以下のコードを
ご覧ください。
