# 構成要素

ここでは、Mjolnirの主な構成要素を概観します。

## Simulator

新規なシミュレーション手法を導入する場合はこのクラスを追加します。

シミュレーションを行うとき、メイン関数から直接呼ばれる唯一のクラスです。
何がどの順番で行われ、どうしたらシミュレーションが終了するかを決めるのが仕事です。

このクラスはシミュレーションに必要な他のクラスをメンバとして管理し、適切な順序で
呼び出します。なので、シミュレーションを行うにあたって必要なクラスを必要なだけ
保持することになります。

## Integrator

新規な時間積分アルゴリズムを導入する場合はこのクラスを追加します。

このクラスは、ForceFieldとSystemを受け取り、Systemに含まれる粒子を1ステップだけ
動かします。

## System

シミュレーションによって時間発展させる粒子を管理します。粒子の位置、速度、力、
名前などを格納します。他に、系全体にかかるパラメータ、境界条件や温度、圧力などを持ちます。

ForceFieldが力を計算するときや、Integratorが粒子を動かすとき、Observerが状態を
ファイルに出力するときなどに受け渡されます。

シミュレーションによっては、同じタンパク質を複数用意して並行してシミュレーションを
行うかもしれません。その際はこのクラスを複数持つようにします。

特殊なデバイスを使ってシミュレーションを高速化する際は、格納方法を変更するために
このクラスの変種を追加する必要があるかも知れません。ですが、たいていの場合この
クラスは単に参照するだけで済むでしょう。

### BoundaryCondition

境界条件を格納します。境界条件がない場合は何もしませんが、周期境界条件が適用
されている場合は、粒子の位置と粒子間ベクトルを境界にそって修正します。

### Topology

Systemが格納しているクラスです。ここには、どのような結合がどの粒子の間に存在する
かの情報がグラフの形で格納されています。

一部の力場は互いに影響を及ぼします。例えば、共有結合のある粒子同士にはnon-bonded
な相互作用がかからないことがあります。そのような情報を力場の間で共有するために、
このクラスに結合の情報を書き込み、力場がそれを参照するようにします。

## ForceField

力場を表現するクラスです。Systemを渡されると、その粒子の配置に従って力を計算し、
渡されたSystemに書き込みます。

3種類のカテゴリに分けられており、それぞれをまとめて管理しているのがForceFieldクラスです。

また、それぞれの力場はInteractionとPotentialという2つの要素から構成されています。

### Local

結合長、結合角、二面角など特定の粒子にかかる力を計算する力場です。

どの粒子間に相互作用が適用されているかの情報はTopologyに書き込まれます。

### Global

分子間力や静電ポテンシャルなど、不特定多数の粒子にかかる力を計算する力場です。

相互作用している粒子のリストはTopologyに書き込まれませんが、結合の情報を読み込む
ことができます。

### External

特定の点や平面との相互作用など、粒子間ではなく外力場からかかる力を計算する力場です。

### InteractionとPotential

Interactionは、力の向きと、エネルギーを計算するのに必要な量（角度など）を計算するクラスです。

Potentialは、エネルギーの値と微分を計算するクラスです。

Interactionは内部でPotentialクラスを呼び出し、実際の力の強さを掛け算して計算します。

数式の形が複雑でPotentialを上手く切り離せない場合は、Interactionは単体で
完結するように実装します。

## Observer

系の現在の状態をファイルに出力するクラスです。

新しいファイルフォーマットを追加する際はこのクラスを追加します。

## Traits

このクラスは特殊なクラスで、特に何もしません。

多くのクラスに共通した型パラメータ、例えば実数型として使う型の精度や、境界条件などを
格納するためのタグ型の役割を果たします。

また、このクラスによって部分特殊化を行うことで、ファイル入力を簡単にしたり、
実装の手間を省くなどの働きをします。特殊な場合にのみ有効になる最適化などを行う際は、
このカテゴリのクラスを追加し、それが渡された場合の特殊化を必要なだけ追加して下さい。
`mjolnir/omp/`ディレクトリにその例があります。
